name: Validate

on:
  push:
    branches: ['**']
  pull_request:
    branches: [main, dev]

# Cancel in-progress runs for the same branch/PR
concurrency:
  group: validate-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-fast:
    name: Lint (clj-kondo)
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Install clj-kondo
        run: |
          curl -sLO https://raw.githubusercontent.com/clj-kondo/clj-kondo/master/script/install-clj-kondo
          chmod +x install-clj-kondo
          sudo ./install-clj-kondo

      - name: Lint
        run: clj-kondo --lint src --lint test --lint dev --fail-level error

  check:
    name: Format + Lint (JVM)
    needs: lint-fast
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '25'

      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@13.2
        with:
          cli: latest

      - name: Cache deps
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: deps-${{ hashFiles('deps.edn') }}
          restore-keys: deps-

      - name: Format check
        run: clojure -M:cljfmt check src test dev

      - name: Lint (JVM)
        run: clojure -M:lint --lint src --lint test --lint dev

  test:
    name: Unit Tests
    needs: check
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '25'

      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@13.2
        with:
          cli: latest

      - name: Cache deps
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: deps-${{ hashFiles('deps.edn') }}
          restore-keys: deps-

      - name: Run tests
        run: clojure -M:dev test

  e2e:
    name: E2E Tests
    needs: test
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '25'

      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@13.2
        with:
          cli: latest

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache Clojure deps
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: deps-${{ hashFiles('deps.edn') }}
          restore-keys: deps-

      - name: Generate ephemeral secrets
        run: |
          echo "COOKIE_SECRET=$(openssl rand -hex 32)" >> config.env
          echo "JWT_SECRET=$(openssl rand -hex 32)" >> config.env

      - name: Start dev server
        run: |
          clojure -M:dev dev &
          echo "Waiting for server on port 8080..."
          timeout 120 bash -c 'until curl -sf http://localhost:8080 > /dev/null 2>&1; do sleep 2; done'
          echo "Server is up."

      - name: Install Playwright
        working-directory: e2e
        run: |
          npm ci
          npx playwright install chromium --with-deps

      - name: Run e2e tests
        working-directory: e2e
        run: |
          npm run test:today-reorder
          npm run test:today-toggle
          npm run test:today-quick-add
          npm run test:today-filter
          npm run test:today-canceled
          npm run test:timer-overlap

      - name: Upload screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-screenshots
          path: e2e/screenshots/
          retention-days: 7
